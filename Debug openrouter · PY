"""
ğŸ” DEBUG VERSION - Print Full OpenRouter Response
Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù„ÙØ­Øµ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ù† OpenRouter
"""

import requests
import json
import os
import logging

logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY", "YOUR_KEY_HERE")

def debug_openrouter_call():
    """
    Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù€ OpenRouter Ù…Ø¹ Ø·Ø¨Ø§Ø¹Ø© ÙƒÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    """
    
    print("\n" + "="*80)
    print("ğŸ” DEBUG: OpenRouter Full Response Inspection")
    print("="*80 + "\n")
    
    # Prompt ØªØ¬Ø±ÙŠØ¨ÙŠ
    test_prompt = "A cute toddler playing in a garden, soft watercolor style"
    
    headers = {
        "Authorization": f"Bearer {OPENROUTER_API_KEY}",
        "Content-Type": "application/json",
    }
    
    payload = {
        "model": "black-forest-labs/flux.2-klein-4b",
        "messages": [
            {
                "role": "user",
                "content": [{"type": "text", "text": test_prompt}]
            }
        ],
        "modalities": ["image"]
    }
    
    print("ğŸ“¤ Sending request...")
    print(f"Model: {payload['model']}")
    print(f"Prompt: {test_prompt}\n")
    
    try:
        response = requests.post(
            "https://openrouter.ai/api/v1/chat/completions",
            headers=headers,
            json=payload,
            timeout=120
        )
        
        print(f"ğŸ“¥ Response Status: {response.status_code}\n")
        
        if response.status_code == 200:
            data = response.json()
            
            # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø¸Ù…
            print("="*80)
            print("ğŸ“‹ FULL RESPONSE (Pretty Printed):")
            print("="*80)
            print(json.dumps(data, indent=2, ensure_ascii=False))
            print("="*80 + "\n")
            
            # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‡ÙŠÙƒÙ„
            print("="*80)
            print("ğŸ” STRUCTURE ANALYSIS:")
            print("="*80)
            
            print(f"\n1ï¸âƒ£ Top-level keys: {list(data.keys())}")
            
            if "choices" in data:
                print(f"\n2ï¸âƒ£ Number of choices: {len(data['choices'])}")
                
                if data["choices"]:
                    choice = data["choices"][0]
                    print(f"\n3ï¸âƒ£ Choice[0] keys: {list(choice.keys())}")
                    
                    if "message" in choice:
                        message = choice["message"]
                        print(f"\n4ï¸âƒ£ Message keys: {list(message.keys())}")
                        
                        # ÙØ­Øµ ÙƒÙ„ Ù…ÙØªØ§Ø­ ÙÙŠ message
                        for key, value in message.items():
                            print(f"\n   ğŸ“Œ message.{key}:")
                            print(f"      Type: {type(value)}")
                            
                            if isinstance(value, str):
                                preview = value[:200] + "..." if len(value) > 200 else value
                                print(f"      Value: {preview}")
                            elif isinstance(value, list):
                                print(f"      Length: {len(value)}")
                                if value:
                                    print(f"      First item type: {type(value[0])}")
                                    print(f"      First item: {value[0]}")
                            elif isinstance(value, dict):
                                print(f"      Keys: {list(value.keys())}")
                            else:
                                print(f"      Value: {value}")
            
            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡ ÙŠØ´Ø¨Ù‡ Ø±Ø§Ø¨Ø· Ø£Ùˆ base64
            print("\n" + "="*80)
            print("ğŸ” SEARCHING FOR IMAGE DATA:")
            print("="*80)
            
            response_str = json.dumps(data)
            
            if "http" in response_str:
                print("âœ… Found 'http' in response")
                # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
                import re
                urls = re.findall(r'https?://[^\s"]+', response_str)
                if urls:
                    print(f"   URLs found: {len(urls)}")
                    for url in urls[:3]:  # Ø£ÙˆÙ„ 3 Ø±ÙˆØ§Ø¨Ø·
                        print(f"   - {url}")
            else:
                print("âŒ No 'http' found in response")
            
            if "base64" in response_str:
                print("âœ… Found 'base64' in response")
            else:
                print("âŒ No 'base64' found in response")
            
            if "image" in response_str.lower():
                print("âœ… Found 'image' keyword in response")
            else:
                print("âŒ No 'image' keyword in response")
            
            print("\n" + "="*80)
            
        else:
            print(f"âŒ Error Response:")
            print(response.text)
            
    except Exception as e:
        print(f"âŒ Exception: {e}")
        import traceback
        traceback.print_exc()


# ============================================================================
# Ø¥Ø¶Ø§ÙØ©: ÙØ­Øµ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ØªØ§Ø­
# ============================================================================

def check_flux_model():
    """
    Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ù†Ù…ÙˆØ°Ø¬ FLUX
    """
    print("\n" + "="*80)
    print("ğŸ” Checking FLUX Model Availability")
    print("="*80 + "\n")
    
    headers = {
        "Authorization": f"Bearer {OPENROUTER_API_KEY}",
    }
    
    try:
        response = requests.get(
            "https://openrouter.ai/api/v1/models",
            headers=headers,
            timeout=10
        )
        
        if response.status_code == 200:
            models = response.json()
            
            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† FLUX models
            flux_models = [
                m for m in models.get("data", []) 
                if "flux" in m.get("id", "").lower()
            ]
            
            if flux_models:
                print(f"âœ… Found {len(flux_models)} FLUX model(s):\n")
                for model in flux_models:
                    print(f"   ğŸ“Œ {model.get('id')}")
                    print(f"      Name: {model.get('name', 'N/A')}")
                    print(f"      Context: {model.get('context_length', 'N/A')}")
                    print()
            else:
                print("âŒ No FLUX models found")
                print("\nğŸ’¡ Available models with 'image' capability:")
                
                image_models = [
                    m for m in models.get("data", [])
                    if "image" in str(m).lower()
                ]
                
                for model in image_models[:5]:
                    print(f"   - {model.get('id')}")
        else:
            print(f"âŒ Error: {response.status_code}")
            
    except Exception as e:
        print(f"âŒ Error: {e}")


# ============================================================================
# MAIN
# ============================================================================

if __name__ == "__main__":
    print("\nğŸš€ Starting OpenRouter Debug Session\n")
    
    # Ø¥Ø°Ø§ ÙƒØ§Ù† API Key Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†ÙØ° Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    if OPENROUTER_API_KEY and OPENROUTER_API_KEY != "YOUR_KEY_HERE":
        print("âœ… API Key found\n")
        
        # 1. ÙØ­Øµ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        check_flux_model()
        
        print("\n" + "="*80)
        input("Press Enter to continue with actual API call...")
        print()
        
        # 2. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªØ¬Ø±ÙŠØ¨ÙŠ
        debug_openrouter_call()
        
    else:
        print("âŒ OPENROUTER_API_KEY not set!")
        print("\nTo use this debug script:")
        print("1. Set environment variable:")
        print("   export OPENROUTER_API_KEY='your-key-here'")
        print("\n2. Or edit this file and replace 'YOUR_KEY_HERE'")
        print("\n3. Run again:")
        print("   python debug_openrouter.py")
