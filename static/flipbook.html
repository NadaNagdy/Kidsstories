<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÇÿµÿ© ŸÖÿÆÿµÿµÿ© - Interactive Flipbook</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --book-shadow: 0 10px 30px rgba(0,0,0,0.3);
            --accent: #00bcd4;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: 'Geeza Pro', 'Arial', sans-serif;
            overflow-x: hidden;
        }

        .header {
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            color: var(--accent);
        }

        #flipbook-container {
            width: 90vw;
            max-width: 1000px;
            height: 70vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #book {
            width: 100%;
            height: 100%;
            box-shadow: var(--book-shadow);
            background: #fff;
        }

        .page {
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-sizing: border-box;
            border: 1px solid #eee;
            position: relative;
        }

        .page img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .page-content {
            padding: 20px;
            text-align: center;
        }

        .controls {
            margin-top: 30px;
            display: flex;
            gap: 20px;
            z-index: 100;
        }

        button {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 50px;
            background: var(--accent);
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            background: #0097a7;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            #flipbook-container {
                height: 50vh;
            }
            .header h1 { font-size: 18px; }
            button { padding: 10px 20px; font-size: 14px; }
        }
    </style>
    <!-- PageFlip Library -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.js"></script>
</head>
<body>

    <div class="header">
        <h1>üìñ ŸÇÿµÿ© <span id="child-name">...</span></h1>
        <p>ŸÖÿ±ÿ±Ÿä ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ŸÑŸÑÿßÿ≥ÿ™ŸÖÿ™ÿßÿπ ÿ®ÿßŸÑŸÇÿµÿ©</p>
    </div>

    <div id="flipbook-container">
        <div id="book" class="stPageFlip">
            <!-- Pages will be injected here -->
        </div>
    </div>

    <div class="controls" id="controls">
        <button id="btn-prev">ÿßŸÑÿ≥ÿßÿ®ŸÇ</button>
        <button id="btn-next">ÿßŸÑÿ™ÿßŸÑŸä</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const storyId = window.location.pathname.split('/').pop() || urlParams.get('id');
            
            if (!storyId) {
                alert('ÿπÿ∞ÿ±ÿßŸãÿå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÇÿµÿ©.');
                return;
            }

            try {
                // Fetch story manifest
                const response = await fetch(`/static/stories/${storyId}/manifest.json`);
                const manifest = await response.json();
                
                document.getElementById('child-name').textContent = manifest.child_name || 'ÿßŸÑÿ®ÿ∑ŸÑ';
                
                const bookElement = document.getElementById('book');
                
                // Add Cover
                addPage(manifest.cover, bookElement);
                
                // Add Pages (Art then Text)
                manifest.pages.forEach(page => {
                    addPage(page.art, bookElement);
                    addPage(page.text, bookElement);
                });

                // Initialize PageFlip
                const pageFlip = new St.PageFlip(bookElement, {
                    width: 1000,
                    height: 1000,
                    size: "stretch",
                    minWidth: 315,
                    maxWidth: 1000,
                    minHeight: 420,
                    maxHeight: 1350,
                    maxShadowOpacity: 0.5,
                    showCover: true,
                    mobileScrollSupport: false
                });

                pageFlip.loadFromHTML(document.querySelectorAll('.page'));

                // Controls
                document.getElementById('btn-prev').addEventListener('click', () => pageFlip.flipPrev());
                document.getElementById('btn-next').addEventListener('click', () => pageFlip.flipNext());

                pageFlip.on('flip', (e) => {
                    // Feedback or sound effects could go here
                });

            } catch (err) {
                console.error(err);
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÇÿµÿ©.');
            }
        });

        function addPage(imgUrl, container) {
            const page = document.createElement('div');
            page.className = 'page';
            const img = document.createElement('img');
            img.src = imgUrl;
            page.appendChild(img);
            container.appendChild(page);
        }
    </script>
</body>
</html>
