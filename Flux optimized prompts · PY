"""
ğŸ¨ FLUX Klein 4B - Optimized Prompt System
Ù†Ø¸Ø§Ù… Ù…ØªØ·ÙˆØ± Ù„ØªÙˆÙ„ÙŠØ¯ prompts Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ù€ FLUX Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª
"""

import json
import hashlib
from typing import Optional

# ============================================================================
# ğŸ§¬ CHARACTER PROFILE (DNA Ø«Ø§Ø¨Øª Ù„Ù„Ø´Ø®ØµÙŠØ©)
# ============================================================================

class CharacterProfile:
    """
    ÙŠØ®Ø²Ù† Character DNA Ø«Ø§Ø¨Øª Ø¨Ø¹Ø¯ ØªØ­Ù„ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„
    Ù„Ø¶Ù…Ø§Ù† CONSISTENCY Ø¹Ø¨Ø± ÙƒÙ„ ØµÙØ­Ø§Øª Ø§Ù„Ù‚ØµØ©
    """
    def __init__(self, name: str, gender: str, vision_description: str):
        self.name = name
        self.gender = gender
        self.vision_description = vision_description.strip()
        self.character_id = self._generate_id()

    def _generate_id(self) -> str:
        base = f"{self.name}-{self.gender}-{self.vision_description}"
        return hashlib.md5(base.encode()).hexdigest()[:10]

    def get_locked_description(self) -> str:
        return f"""
CHARACTER ID: {self.character_id}

This is the SAME child in every page.

{self.vision_description}

CRITICAL CONSISTENCY RULES:
- Face shape must remain IDENTICAL
- Eye size and shape must remain IDENTICAL
- Hair color and texture must remain IDENTICAL
- Skin tone must remain IDENTICAL
- Do NOT modify facial structure
- Do NOT randomize features
- Do NOT change ethnicity
- Maintain visual continuity across all pages
"""

# ============================================================================
# ğŸ“š FLUX PROMPT BUILDER
# ============================================================================

class FluxPromptBuilder:
    """
    Ø¨Ù†Ø§Ø¡ prompts Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ù€ FLUX Klein 4B
    """
    REFERENCE_STYLE = {
        "medium": "digital illustration with soft painterly textures",
        "technique": "children's storybook art, blend of digital painting and watercolor washes",
        "colors": "rich saturated colors with soft gradients, deep blues, warm golds, creamy whites",
        "texture": "visible brush strokes, paper texture, gentle blending",
        "atmosphere": "enchanting bedtime story aesthetic, cozy and whimsical",
        "quality": "high definition children's book illustration, professional publication quality"
    }

    def __init__(self):
        self.style = self.REFERENCE_STYLE

    def build_flux_prompt(
        self,
        character_desc: str,
        action: str,
        style_override: Optional[str] = None,
        lighting: str = "soft warm magical lighting",
        mood: str = "enchanting and cozy",
        composition: str = "centered subject, children's book page layout",
        use_case: str = "children's storybook illustration"
    ) -> str:
        """
        Ø¨Ù†Ø§Ø¡ prompt ÙƒØ§Ù…Ù„ Ø¨Ù‡ÙŠÙƒÙ„ FLUX Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡
        """
        subject = f"{character_desc}, {action}"
        style = style_override or (
            f"{self.style['medium']}, "
            f"{self.style['technique']}, "
            f"{self.style['colors']}, "
            f"{self.style['texture']}"
        )

        lighting_desc = f"{lighting}, {mood}, {self.style['atmosphere']}"
        composition_desc = f"{composition}, space for text at top of page, storybook page format"
        quality = f"for {use_case}, {self.style['quality']}, sharp detail, vibrant colors, professional children's book art, suitable for ages 1-5"

        return f"{subject}. Style: {style}. Lighting: {lighting_desc}. Composition: {composition_desc}. Quality: {quality}"

    def create_story_prompt(
        self,
        character_profile: CharacterProfile,
        scene_description: str,
        page_number: int = 1,
        total_pages: int = 5,
        is_cover: bool = False
    ) -> str:
        """
        Ø¥Ù†Ø´Ø§Ø¡ prompt Ù„ØµÙØ­Ø© Ù‚ØµØ© Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Character DNA Ø«Ø§Ø¨Øª
        """
        locked_character = character_profile.get_locked_description()

        lighting_progression = {
            1: "clear natural daylight",
            2: "bright soft daylight",
            3: "gentle afternoon light",
            4: "warm evening light",
            5: "dreamy twilight blue tones"
        }

        lighting = lighting_progression.get(page_number, "soft magical lighting")

        if is_cover:
            composition = "storybook cover layout, centered subject, space for title at top"
            use_case = "children's storybook cover"
        else:
            composition = f"page {page_number} of {total_pages}, storybook interior layout"
            use_case = "children's storybook page"

        return self.build_flux_prompt(
            character_desc=locked_character,
            action=scene_description,
            lighting=lighting,
            mood="whimsical, magical, cozy",
            composition=composition,
            use_case=use_case
        )

# ============================================================================
# ğŸ“ EXAMPLES
# ============================================================================

def generate_example_prompts() -> list:
    builder = FluxPromptBuilder()
    vision_desc = (
        "adorable toddler girl with curly brown hair, warm skin, large brown eyes, rosy cheeks, smiling joyfully, wearing a colorful casual outfit"
    )
    profile = CharacterProfile(name="Ù„ÙˆØ¬Ù‰", gender="Ø¨Ù†Øª", vision_description=vision_desc)

    examples = []

    # Cover
    cover_prompt = builder.create_story_prompt(
        character_profile=profile,
        scene_description=(
            "riding on the back of a magical white fluffy bear, flying through starry night sky with glowing golden moon and twinkling stars, joyful adventure"
        ),
        page_number=1,
        is_cover=True
    )
    examples.append({"type": "cover", "prompt": cover_prompt})

    # Page 1
    page1_prompt = builder.create_story_prompt(
        character_profile=profile,
        scene_description=(
            "sitting at a colorful table with fresh fruits, tasting a new food with curiosity and bravery, bright cheerful kitchen"
        ),
        page_number=1,
        total_pages=5
    )
    examples.append({"type": "page_1_courage", "prompt": page1_prompt})

    # Page 2
    page2_prompt = builder.create_story_prompt(
        character_profile=profile,
        scene_description=(
            "giving a gentle high-five to a friendly toddler friend, smiling together in colorful playground with swings and flowers"
        ),
        page_number=2,
        total_pages=5
    )
    examples.append({"type": "page_2_friendship", "prompt": page2_prompt})

    # Page 5
    page5_prompt = builder.create_story_prompt(
        character_profile=profile,
        scene_description=(
            "sleeping peacefully in cozy bed with magical glowing stars, soft stuffed toys nearby, dreamy bedroom with moon-shaped nightlight casting gentle glow"
        ),
        page_number=5,
        total_pages=5
    )
    examples.append({"type": "page_5_bedtime", "prompt": page5_prompt})

    return examples

# ============================================================================
# ğŸ¯ PROCESS STORY WITH FLUX OPTIMIZATION
# ============================================================================

def process_story_with_flux_prompts(story_json_path: str, character_profile: CharacterProfile, output_path: str):
    """
    Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‚ØµØ© ÙƒØ§Ù…Ù„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Character DNA Ø«Ø§Ø¨Øª ÙˆFLUX-optimized prompts
    """
    with open(story_json_path, 'r', encoding='utf-8') as f:
        story_data = json.load(f)

    builder = FluxPromptBuilder()
    total_pages = len(story_data.get('pages', []))

    for idx, page in enumerate(story_data.get('pages', []), 1):
        original_prompt = page.get('prompt', '')
        scene_desc = original_prompt.replace('{child_name}', '').strip()
        flux_prompt = builder.create_story_prompt(
            character_profile=character_profile,
            scene_description=scene_desc,
            page_number=idx,
            total_pages=total_pages,
            is_cover=(idx == 1)
        )
        page['flux_optimized_prompt'] = flux_prompt
        page['original_prompt'] = original_prompt

    with open(output_path, 'w', encoding='utf-8') as f:
        json.dump(story_data, f, ensure_ascii=False, indent=2)

    print(f"âœ… Processed {total_pages} pages")
    print(f"ğŸ“ Saved to: {output_path}")

# ============================================================================
# ğŸ§ª TESTING
# ============================================================================

if __name__ == "__main__":
    print("="*80)
    print("ğŸ¨ FLUX Klein 4B - Optimized Prompt Generator")
    print("="*80 + "\n")

    examples = generate_example_prompts()
    for i, example in enumerate(examples, 1):
        print(f"\n{'='*80}")
        print(f"ğŸ“ Example {i}: {example['type']}")
        print(f"{'-'*80}")
        print(f"{example['prompt'][:500]}...")  # Short preview
    print("\nâœ… Example prompts generated!")

    with open('flux_prompt_examples.json', 'w', encoding='utf-8') as f:
        json.dump(examples, f, ensure_ascii=False, indent=2)
    print("\nğŸ’¾ Saved to: flux_prompt_examples.json")
